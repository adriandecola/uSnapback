<!DOCTYPE html>
<!--
  File:             amplicon.html
  Description:      Main entry point for the website
  Author:           Adrian deCola
  Relative Path:    uSnapback/src/amplicon.html
  Linked files:     ./style.css
-->
<html lang="en">
<head>
    <!-- 
        Specifies the character encoding for the HTML document
        UTF-8 is a universal character encoding that supports all 
        written languages, symbols, and emojis 
    -->
    <meta charset="UTF-8">

    <!-- 
        Sets width of viewport to device's screen width 
        initial-scale=1.0 makes sure the browser doesn't start 
        zoomed in by default 
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 
        Sets compatibility mode for older versions of Internet Explorer. 
        The X-UA-Compatible tag tells Internet Explorer (up to version 11) 
        which rendering engine to use for better compatibility and functionality. 
        This tag is now mostly unnecessary because modern browsers no longer 
        require it, but it remains useful for legacy support. 
    -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- The title of the document, shown in the browser tab -->
    <title>uSnapback</title>

    <!-- Brief description of the webpage for search engines -->
    <meta name="description" content="An application to design a snapback primer for single base variant asymmetrical PCR." />

    <!--
        Open Graph metadata for sharing content on social platforms. 
        These tags control the webpage appearence.
    -->
    <!-- The title of the content, shown as the heading in the preview card -->
    <meta property="og:title" content="uSnapback"/>
    <!-- The image displayed in the preview card -->
	<meta property="og:image" content=""/>
    <!-- Canonical URL of the webpage, which helps with SEO -->
	<meta property="og:url" content="https://dna-utah.com/uSnapback"/>
    <!-- The name of the website where the content is hosted -->
	<meta property="og:site_name" content="DNA Utah"/>
    <!-- A short description of the content, shown in the preview -->
	<meta property="og:description" content="An application to design a snapback primer for single base variant asymmetrical PCR."/>

    <!-- Link to CSS File -->
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
	<!-- Header -->
	<header class="app-header">
		<div class="title">uSnapback</div>
	</header>

	<!-- Main content -->
	<main class="app-main">

		<!-- Instructions -->
		<section class="instructions">
			<p>Please input the entire amplicon sequence starting with a 5' end. This
			amplicon sequence includes the forward primer as well as the
			complementation of the reverse primer.</p>
		</section>

		<!-- Form -->
		<form id="ampliconForm" autocomplete="off" novalidate>
			<label for="ampliconInput" class="field-label">
				Amplicon Sequence (5'→3')
			</label>

			<div class="textarea-wrapper">
				<textarea
					id="ampliconInput" name="ampliconInput" required spellcheck="false"
					placeholder="Enter only A, C, G, T (line-breaks, tabs, and spaces allowed)"
					pattern="[ACGTacgt\s]+" wrap="soft"></textarea>

				<!-- Live Character Count (nucleotides only, whitespace ignored) -->
				<div id="ampliconCount" class="char-count" aria-live="polite"></div>
			</div>

			<!-- Live Amplicon Stats -->
			<div id="ampliconStats" class="stats-display" hidden>
				<p><strong>Amplicon length:</strong> <code id="ampLenOut"></code></p>
				<p><strong>GC content:</strong> <code id="ampGcOut"></code></p>
			</div>
		</form>

	</main>

	<!-- Floating PREVIOUS button -->
	<button type="button" id="prevBtn" class="prev-btn">⭠ Back</button>

	<!-- Floating RESTART button -->
    <button type="button" id="restartBtn" class="restart-btn">Restart ↺</button>

	<!-- Floating NEXT button -->
	<button type="submit"
			id="nextBtn"
			class="next-btn"
			form="ampliconForm">Next ⭢</button>


	<!-- Inline script: restrict input, store sequence, go to next page -->
	<script>
		(() => {
			const input  = document.getElementById('ampliconInput');
			const form   = document.getElementById('ampliconForm');
			const prev  = document.getElementById('prevBtn');
			const statsBox  = document.getElementById('ampliconStats');
			const ampLenOut = document.getElementById('ampLenOut');
			const ampGcOut  = document.getElementById('ampGcOut');
			const nextPg = 'primers.html';
			const prevPg = 'start.html';
			const restartBtn = document.getElementById('restartBtn');
			const countBox = document.getElementById('ampliconCount');

			// maximum nt allowed
			const AMPLICON_LIMIT = 1000;

			// IME-composition guard (place near other const/let declarations)
			let isComposing = false;


			/* Restore previously-saved amplicon (raw, with whitespace) */
			const savedRaw = sessionStorage.getItem('sequenceRaw');
			if (savedRaw) input.value = savedRaw;
			// Update amplicon statistics, if there is an amplicon
			updateAmpliconStats();
			// Update nucleotice count
			updateCharCount();


			
			/* Helper function to update amplicon statistics */
			function updateAmpliconStats() {
				const raw = input.value.trim();
				const seq = raw.replace(/\s+/g, '');   // collapse whitespace
				const n   = seq.length;

				if (n === 0) {
					statsBox.hidden = true;
					ampLenOut.textContent = '';
					ampGcOut.textContent  = '';
					return;
				}

				const gc  = (seq.match(/[GC]/g) || []).length;
				const pct = (gc / n) * 100;

				ampLenOut.textContent = String(n);
				ampGcOut.textContent  = `${pct.toFixed(1)}%`;
				statsBox.hidden = false;
			}

			// Helper function to update the nucleotide count
			function updateCharCount() {
				const seqLen = input.value.replace(/\s+/g, '').length; // nucleotides only
				countBox.textContent = `${seqLen} / ${AMPLICON_LIMIT} nt`;
				countBox.classList.toggle('over', seqLen > AMPLICON_LIMIT);
			}

			// Helper function to sanitize while preserving caret/selection & scroll
			function sanitizeAndPreserveCaret(el) {
				// capture pre-sanitize positions
				const raw = el.value;
				const selStart = el.selectionStart;
				const selEnd   = el.selectionEnd;
				const scrollY  = el.scrollTop;

				// build sanitized string + mapped selection
				let out = '';
				let newStart = 0, newEnd = 0;

				for (let i = 0; i < raw.length; i++) {
					const ch = raw[i];
					// keep whitespace or A/C/G/T (any case); drop everything else
					const isWhite = /\s/.test(ch);
					const isBase  = /[ACGTacgt]/.test(ch);
					if (isWhite || isBase) {
						out += isBase ? ch.toUpperCase() : ch;
						if (i < selStart) newStart++;
						if (i < selEnd)   newEnd++;
					}
				}

				// only touch DOM if something actually changed
				if (out !== raw) {
					el.value = out;
					el.selectionStart = newStart;
					el.selectionEnd   = newEnd;
					el.scrollTop = scrollY; // restore scroll in long inputs
				}
			}


			/* --------------------------------------------------
			Event: restart button → clear storage and go to start.html
			-------------------------------------------------- */
			restartBtn.addEventListener('click', () => {
				sessionStorage.clear();
				window.location.href = 'start.html';
			});

			// IME composition listeners
			input.addEventListener('compositionstart', () => { isComposing = true; });
			input.addEventListener('compositionend', () => {
				isComposing = false;
				sanitizeAndPreserveCaret(input);
				// keep your existing live-updates in sync
				sessionStorage.setItem('sequenceRaw', input.value.trim());
				updateAmpliconStats();
				updateCharCount();
			});


			input.addEventListener('input', (e) => {
				// skip during IME composition; sanitize on compositionend instead
				if (e.isComposing || isComposing) return;

				sanitizeAndPreserveCaret(input);

				// Update the raw amplicon in session storage
				sessionStorage.setItem('sequenceRaw', input.value.trim());
				// Update amplicon statistics
				updateAmpliconStats();
				// Update nucleotide count
				updateCharCount();
			});

			// CHANGED: Tab inserts '\t' while preserving caret, scroll, stats, and storage
			input.addEventListener('keydown', (e) => {
				if (e.key !== 'Tab') return;

				// If an IME composition is active, let Tab do its default (usually focus move)
				if (isComposing) return;

				e.preventDefault();

				const s = input.selectionStart;
				const t = input.selectionEnd;
				const scrollY = input.scrollTop;

				// Insert a literal tab at the current selection
				input.value = input.value.slice(0, s) + '\t' + input.value.slice(t);

				// Place caret right after the inserted tab and restore scroll
				input.selectionStart = input.selectionEnd = s + 1;
				input.scrollTop = scrollY;

				// Sanitize + uppercase while preserving the updated caret/scroll
				sanitizeAndPreserveCaret(input);

				// Keep everything else in sync (session, stats, count)
				sessionStorage.setItem('sequenceRaw', input.value.trim());
				updateAmpliconStats();
				updateCharCount();
			});





			/* 2. On submit, save sequence and navigate forward */
			form.addEventListener('submit', (e) => {
				e.preventDefault();
				/*---------- Checking the amplicon ----------*/
				const raw  = input.value.trim();        // preserve user formatting
				const seq  = raw.replace(/\s+/g,'');    // compact for validation
				if (!seq) {
					alert('Amplicon sequence not found. Please restart.');
					return;
				}
				if (seq.length<33) {
					alert('The amplicon it too short.');
					return;
				}
				if (seq.length > AMPLICON_LIMIT) {
					alert(`Amplicon exceeds ${AMPLICON_LIMIT} nucleotides (${seq.length}). Please shorten it.`);
					return;
				}

				// Store sequence
				sessionStorage.setItem('sequence', seq);
				sessionStorage.setItem('sequenceRaw', raw);

				// Navigate to next page
				window.location.href = nextPg;
			});

			/* 3. Handle Previous button click */
			prev.addEventListener('click', () => {
				// Store sequence
				sessionStorage.setItem('sequenceRaw', input.value.trim());
				// Navigate to previous page
				window.location.href = prevPg;
		});
		})();
	</script>
</body>


</html>
