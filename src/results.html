<!DOCTYPE html>
<!--
  File:             results.html
  Description:      Main entry point for the website
  Author:           Adrian deCola
  Relative Path:    uSnapback/src/results.html
  Linked files:     ./style.css, script.js
-->
<html lang="en">
<head>
    <!-- 
        Specifies the character encoding for the HTML document
        UTF-8 is a universal character encoding that supports all 
        written languages, symbols, and emojis 
    -->
    <meta charset="UTF-8">

    <!-- 
        Sets width of viewport to device's screen width 
        initial-scale=1.0 makes sure the browser doesn't start 
        zoomed in by default 
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 
        Sets compatibility mode for older versions of Internet Explorer. 
        The X-UA-Compatible tag tells Internet Explorer (up to version 11) 
        which rendering engine to use for better compatibility and functionality. 
        This tag is now mostly unnecessary because modern browsers no longer 
        require it, but it remains useful for legacy support. 
    -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- The title of the document, shown in the browser tab -->
    <title>uSnapback</title>

    <!-- Brief description of the webpage for search engines -->
    <meta name="description" content="An application to design a snapback primer for single base variant asymmetrical PCR." />

    <!--
        Open Graph metadata for sharing content on social platforms. 
        These tags control the webpage appearence.
    -->
    <!-- The title of the content, shown as the heading in the preview card -->
    <meta property="og:title" content="uSnapback"/>
    <!-- The image displayed in the preview card -->
	<meta property="og:image" content=""/>
    <!-- Canonical URL of the webpage, which helps with SEO -->
	<meta property="og:url" content="https://dna-utah.com/uSnapback"/>
    <!-- The name of the website where the content is hosted -->
	<meta property="og:site_name" content="DNA Utah"/>
    <!-- A short description of the content, shown in the preview -->
	<meta property="og:description" content="An application to design a snapback primer for single base variant asymmetrical PCR."/>

    <!-- Link to CSS File -->
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
	<!-- Header -->
	<header class="app-header">
		<div class="title">uSnapback</div>
	</header>

	<!-- Main content -->
	<main class="app-main">

        <section class="instructions">
            <p>
                The snapback primer has been calculated using all inputs you provided.
                Review the design below. If anything looks off, simply use your browser’s
                back button to tweak the inputs and re-run.
            </p>
        </section>

        <!-- results injected by JS -->
        <div id="resultBox" class="result-card" hidden>
            <h2>Snapback Primer&nbsp;(5′→3′)</h2>

                <!-- Raw sequence for copy/paste -->
                <pre id="snapSeq" class="sequence-raw"></pre>

                <!-- Segmented, color-coded representation -->
                <div class="sequence-visual">
                    <div
                        id="snapSeqDiagram"
                        class="sequence-visual__line"
                        aria-label="Segmented snapback primer"
                    ></div>

                    <div class="sequence-visual__legend">
                        <h3 class="sequence-visual__legend-title">Key</h3>
                        <ul class="sequence-visual__legend-list">
                            <li>
                                <span class="legend-swatch seg-mismatch-3p"></span>
                                3′ blocking mismatches on tail side
                                <small>(fivePrimerLimSnapExtMismatches)</small>
                            </li>
                            <li>
                                <span class="legend-swatch seg-stem"></span>
                                Stem (tail side)
                                <small>(fivePrimeStem)</small>
                            </li>
                            <li>
                                <span class="legend-swatch seg-inner-loop"></span>
                                Inner-loop mismatches on tail side
                                <small>(fivePrimeInnerLoopMismatches)</small>
                            </li>
                            <li>
                                <span class="legend-swatch seg-primer"></span>
                                Forward primer
                                <small>(forwardPrimer)</small>
                            </li>
                        </ul>
                    </div>
                </div>

            <h2>Limiting Primer&nbsp;(5′→3′)</h2>
            <pre id="limitSeq"></pre>

            <h3 class="alt-title">Extended Snapback Product (Amplicon Frame)</h3>

                <div class="sequence-visual">
                    <div
                        id="extendedSnapDiagram"
                        class="sequence-visual__line"
                        aria-label="Extended product around SNV"
                    ></div>

                    <div class="sequence-visual__legend">
                        <h3 class="sequence-visual__legend-title">Key</h3>
                        <ul class="sequence-visual__legend-list">
                            <li>
                                <span class="legend-swatch seg-stuff"></span>
                                Forward primer &amp; upstream sequence
                                <small>(stuffBetween)</small>
                            </li>
                            <li>
                                <span class="legend-swatch seg-inner-loop-3p"></span>
                                Inner-loop mismatches (3′ side)
                                <small>(threePrimeInnerLoopMismatches)</small>
                            </li>
                            <li>
                                <span class="legend-swatch seg-stem-3p"></span>
                                Stem (3′ side)
                                <small>(threePrimeStem)</small>
                            </li>
                            <li>
                                <span class="legend-swatch seg-mismatch-3p"></span>
                                3′ blocking mismatches (limiting side)
                                <small>(threePrimerLimSnapExtMismatches)</small>
                            </li>
                            <li>
                                <span class="legend-swatch seg-rest"></span>
                                Rest of amplicon
                                <small>(threePrimerRestOfAmplicon)</small>
                            </li>
                            <li>
                                <span class="legend-swatch legend-snv"></span>
                                SNV base in stem
                                <small>(snvOnThreePrimeStem.indexInThreePrimeStem)</small>
                            </li>
                        </ul>
                    </div>
                </div>


            <ul style="margin-top:1rem">
                <li><strong>Tail appended to:</strong> <span id="tailSide"></span></li>
                <li><strong>SNV on tail matches:</strong> <span id="matchesWild"></span></li>
                <li><strong>Wild-type&nbsp;T<sub>m</sub>:</strong> <span id="wildTm"></span> °C</li>
                <li><strong>Variant&nbsp;T<sub>m</sub>:</strong> <span id="varTm"></span> °C</li>
            </ul>

            <!-- ΔTm table -->
            <h3 class="alt-title">Alternate Snapback ΔT<sub>m</sub> Options (based on Wittwer parameters)</h3>
            <div class="table-wrapper">
                <table class="delta-table" id="deltaTable" aria-describedby="deltaCaption">
                    <thead>
                        <tr>
                            <th scope="col">Tail on ROW Matches COL </th>
                            <th scope="col">Wild base</th>
                            <th scope="col">Variant base</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">Forward primer</th>
                            <td id="dt-fwd-wild">—</td>
                            <td id="dt-fwd-var">—</td>
                        </tr>
                        <tr>
                            <th scope="row">Reverse primer</th>
                            <td id="dt-rev-wild">—</td>
                            <td id="dt-rev-var">—</td>
                        </tr>
                    </tbody>
                    <caption id="deltaCaption">
                        ΔT<sub>m</sub> = | T<sub>m</sub>(snapback with wild allele) − T<sub>m</sub>(snapback with variant allele) | (°C)
                    </caption>
                </table>
            </div>
        </div>
        <!-- full-page loading overlay ▼▼ -->
        <div id="loadingOverlay" class="loading-overlay" hidden>
            <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
            <p>Calculating snapback&nbsp;primer…</p>
        </div>

    </main>


	<!-- Floating PREVIOUS button -->
	<button type="button" id="prevBtn" class="prev-btn">⭠ Back</button>

	<!-- Floating RESTART button -->
    <button type="button" id="restartBtn" class="restart-btn">Restart ↺</button>


	<!-- ───────────── Scripts ───────────── -->
    <script type = "module">
        import { createSnapback } from './script.js';

        // Visualization helpers for snapback / extended products
        function renderSnapbackPrimerDiagram(descriptivePrimer) {
            const container = document.getElementById('snapSeqDiagram');
            if (!container || !descriptivePrimer) return;

            // clear any old content
            container.textContent = '';

            const segments = [
                {
                    key: 'fivePrimerLimSnapExtMismatches',
                    className: 'seg-mismatch-3p',
                    label: "3′ blocking mismatches (tail side)",
                },
                {
                    key: 'fivePrimeStem',
                    className: 'seg-stem',
                    label: 'Stem (tail side)',
                },
                {
                    key: 'fivePrimeInnerLoopMismatches',
                    className: 'seg-inner-loop',
                    label: 'Inner-loop mismatches (tail side)',
                },
                {
                    key: 'forwardPrimer',
                    className: 'seg-primer',
                    label: 'Forward primer',
                },
            ];

            segments.forEach((seg, idx) => {
                const seq = descriptivePrimer[seg.key];
                if (!seq || !seq.length) return;

                const span = document.createElement('span');
                span.className = `dna-segment ${seg.className}`;
                span.textContent = seq;
                span.dataset.segmentLabel = seg.label;
                container.appendChild(span);

                if (idx !== segments.length - 1) {
                    const sep = document.createElement('span');
                    sep.className = 'dna-segment-separator';
                    sep.textContent = ' · ';
                    container.appendChild(sep);
                }
            });
        }

        function renderExtendedSnapbackDiagram(descriptiveExtended) {
            const container = document.getElementById('extendedSnapDiagram');
            if (!container || !descriptiveExtended) return;

            container.textContent = '';

            const snvIndex =
                descriptiveExtended.snvOnThreePrimeStem?.indexInThreePrimeStem;

            const segments = [
                {
                    key: 'stuffBetween',
                    className: 'seg-stuff',
                    label: 'Forward primer & upstream',
                },
                {
                    key: 'threePrimeInnerLoopMismatches',
                    className: 'seg-inner-loop-3p',
                    label: 'Inner-loop mismatches (3′ side)',
                },
                {
                    key: 'threePrimeStem',
                    className: 'seg-stem-3p',
                    label: 'Stem (3′ side)',
                },
                {
                    key: 'threePrimerLimSnapExtMismatches',
                    className: 'seg-mismatch-3p',
                    label: '3′ blocking mismatches (limiting side)',
                },
                {
                    key: 'threePrimerRestOfAmplicon',
                    className: 'seg-rest',
                    label: 'Rest of amplicon',
                },
            ];

            segments.forEach((seg, idx) => {
                let seq = descriptiveExtended[seg.key];
                if (!seq || !seq.length) return;

                // Special case: mark SNV base inside threePrimeStem
                if (
                    seg.key === 'threePrimeStem' &&
                    Number.isInteger(snvIndex) &&
                    snvIndex >= 0 &&
                    snvIndex < seq.length
                ) {
                    const before = seq.slice(0, snvIndex);
                    const snvBase = seq[snvIndex];
                    const after = seq.slice(snvIndex + 1);

                    const stemSpan = document.createElement('span');
                    stemSpan.className = `dna-segment ${seg.className}`;
                    stemSpan.dataset.segmentLabel = seg.label;
                    container.appendChild(stemSpan);

                    if (before.length) {
                        const beforeSpan = document.createElement('span');
                        beforeSpan.textContent = before;
                        stemSpan.appendChild(beforeSpan);
                    }

                    const snvSpan = document.createElement('span');
                    snvSpan.textContent = snvBase;
                    snvSpan.className = 'snv-base';
                    stemSpan.appendChild(snvSpan);

                    if (after.length) {
                        const afterSpan = document.createElement('span');
                        afterSpan.textContent = after;
                        stemSpan.appendChild(afterSpan);
                    }
                } else {
                    const span = document.createElement('span');
                    span.className = `dna-segment ${seg.className}`;
                    span.textContent = seq;
                    span.dataset.segmentLabel = seg.label;
                    container.appendChild(span);
                }

                if (idx !== segments.length - 1) {
                    const sep = document.createElement('span');
                    sep.className = 'dna-segment-separator';
                    sep.textContent = ' · ';
                    container.appendChild(sep);
                }
            });
        }


        (async () => {
            /* ---------- DOM elements ---------- */
            const prevBtn    = document.getElementById('prevBtn');
            const restartBtn = document.getElementById('restartBtn');
            const resultBox  = document.getElementById('resultBox');
            const overlay    = document.getElementById('loadingOverlay');

            /* ---------- Nav targets ---------- */
            const PREV  = 'desiredTm.html';
            const START = 'start.html';

            // maximum nt allowed
			const AMPLICON_LIMIT = 1000;

            /* ---------- Back button ---------- */
            prevBtn.addEventListener('click', () => {
                /* keep current inputs intact – just step back */
                window.location.href = PREV;
            });

            /* --------------------------------------------------
			Event: restart button → clear storage and go to start.html
			-------------------------------------------------- */
			restartBtn.addEventListener('click', () => {
				sessionStorage.clear();
				window.location.href = 'start.html';
			});

            /* ---------- Pull inputs ------------ */
            
            const seq      = sessionStorage.getItem('sequence');
            const fwdLen   = +sessionStorage.getItem('forwardPrimerLen');
            const revLen   = +sessionStorage.getItem('reversePrimerLen');
            const snvIndex = +sessionStorage.getItem('snvIndex');
            const snvBase  = sessionStorage.getItem('snvBase');
            const tm       = +sessionStorage.getItem('desiredTm');

            // Helper function 
            const goBack = msg => {
                alert(msg +
                    '\n\nYou will now be redirected to the amplicon page so you can adjust your inputs.');
                window.location.href = 'amplicon.html';
            };

            // Type checking
            /*---------- Checking the amplicon ----------*/
            if (!seq) {
                goBack('Amplicon sequence not found. Please restart.');
                return;
            }
            if (seq.length<33) {
                goBack('The amplicon it too short.');
                return;
            }
            if (seq.length > AMPLICON_LIMIT) {
                goBack(`Amplicon exceeds ${AMPLICON_LIMIT} nucleotides (${seq.length}). Please shorten it.`);
                return;
            }

            /*---------- Checking the primers ----------*/
            if (!Number.isInteger(fwdLen) || !Number.isInteger(revLen)) {
                goBack('Please enter valid primer lengths.');
                return;
            }
            if (fwdLen < 12 || revLen < 12) {
                goBack('Each primer must be at least 12 nucleotides long.');
                return;
            }
            if (fwdLen > seq.length) {                     // NEW
                goBack('Forward primer length exceeds amplicon length.');
                return;
            }
            if (revLen > seq.length) {                     // NEW
                goBack('Reverse primer length exceeds amplicon length.');
                return;
            }
            if (fwdLen + revLen > seq.length) {
                goBack('Combined primer lengths exceed amplicon length.');
                return;
            }

            /*---------- Checking variant index and base ----------*/
            if (!Number.isInteger(snvIndex) || snvIndex< 0 || snvIndex >= seq.length) {
                alert('Variant index is out of range.'); return;
            }
            if (!'ACGT'.includes(snvBase)) {
                alert('Please select a variant base.'); return;
            }
            /* overlaps either primer region */
            if (snvIndex < fwdLen || snvIndex >= seq.length - revLen) {
                alert('SNV overlaps a primer-binding site. Choose a different index.');
                return;
            }
            /* too close—need ≥ 3-bp gap (= 4 bp away) */
            if (snvIndex < fwdLen + 3) {
                alert('SNV is too close to the forward primer (need ≥ 3-bp gap).');
                return;
            }
            if (snvIndex > seq.length - revLen - 4) {
                alert('SNV is too close to the reverse primer (need ≥ 3-bp gap).');
                return;
            }
            // make sure variant base is different from wild-type base
            if (snvBase === seq[snvIndex]) {
                alert(`Variant base must be different from the wild-type base at index ${snvIndex} (${seq[snvIndex]}).`);
                return;
            }

            /*---------- Checking Tm ----------*/
            if (!Number.isInteger(tm)) {
                alert('Tm must be a whole number.');
                return;
            }
            if (tm < 40 || tm > 80) {
                alert('Tm must be between 40 °C and 80 °C.');
                return;
            }

            try {
                overlay.hidden = false; // Show loading screen
                const result = await createSnapback(        /* now referenced from global scope */
                    seq,
                    fwdLen,
                    revLen,
                    { index: snvIndex, variantBase: snvBase },
                    tm
                );

                // For debugging
                console.log(result);

                /* populate UI */
                document.getElementById('snapSeq' ).textContent = result.snapbackSeq;
                document.getElementById('limitSeq').textContent = result.limitingPrimerSeq;
                renderSnapbackPrimerDiagram(result.descriptiveUnExtendedSnapbackPrimer); // build segmented/color-coded diagrams
                renderExtendedSnapbackDiagram(result.descriptiveExtendedSnapback); // build segmented/color-coded diagrams
                document.getElementById('tailSide').textContent =
                    result.tailOnForwardPrimer ? 'Forward primer' : 'Reverse primer';
                document.getElementById('matchesWild').textContent =
                    result.matchesWild ? 'Wild allele' : 'Variant allele';
                
                                
                // build display strings for Wild/Variant with labels: Wittwer, Rochester, SantaLucia
                const wittWild = result.snapbackMeltingTms?.wildTm;
                const rochWild = result.snapbackTmRochester?.wildTm;
                const slWild   = result.snapbackTmSantaLucia?.wildTm;
                const wildParts = [];
                if (Number.isFinite(wittWild)) wildParts.push(`${wittWild.toFixed(1)} -Wittwer`);
                if (Number.isFinite(rochWild)) wildParts.push(`${rochWild.toFixed(1)} -Rochester`);
                if (Number.isFinite(slWild))   wildParts.push(`${slWild.toFixed(1)} -SantaLucia`);
                document.getElementById('wildTm').textContent = wildParts.length ? wildParts.join(', ') : '—';

                const wittVar = result.snapbackMeltingTms?.variantTm;
                const rochVar = result.snapbackTmRochester?.variantTm;
                const slVar   = result.snapbackTmSantaLucia?.variantTm;
                const varParts = [];
                if (Number.isFinite(wittVar)) varParts.push(`${wittVar.toFixed(1)} -Wittwer`);
                if (Number.isFinite(rochVar)) varParts.push(`${rochVar.toFixed(1)} -Rochester`);
                if (Number.isFinite(slVar))   varParts.push(`${slVar.toFixed(1)} -SantaLucia`);
                document.getElementById('varTm').textContent = varParts.length ? varParts.join(', ') : '—'

                // Populate ΔTm table (gracefully handle null/undefined)
                const fmt = v => {
                    const n = Number(v);
                    return Number.isFinite(n) ? n.toFixed(1) : '—';
                };
                const d = result.meltingTempDiffs ?? {};
                document.getElementById('dt-fwd-wild').textContent = fmt(d.onForwardPrimer?.matchWild);
                document.getElementById('dt-fwd-var' ).textContent = fmt(d.onForwardPrimer?.matchVariant);
                document.getElementById('dt-rev-wild').textContent = fmt(d.onReversePrimer?.matchWild);
                document.getElementById('dt-rev-var' ).textContent = fmt(d.onReversePrimer?.matchVariant);

                /* Show results and hide loading screen */
                resultBox.hidden = false;
	            overlay.hidden   = true;
            } catch (err) {
                overlay.hidden = true; // Hide loading screen
                console.error(err);
                goBack(err.message || 'Snapback calculation failed.');
            }
        })();
    </script>

</body>

</html>